name: Deploy to Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
        type: string

permissions: write-all

env:
  OPENSHIFT_NAMESPACE_TOOLS: 6cdc9e-tools
  OPENSHIFT_NAMESPACE_TEST: 6cdc9e-test
  IMAGE_NAME: rproxy
  APP_NAME: rproxy

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format v1.2.3"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag exists
        id: check-tag
        run: |
          if git rev-parse "${{ needs.validate.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ needs.validate.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag ${{ needs.validate.outputs.version }} does not exist, will create"
          fi

      - name: Create Git Tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.validate.outputs.version }}" -m "Release ${{ needs.validate.outputs.version }}"
          git push origin "${{ needs.validate.outputs.version }}"

      - name: Create GitHub Release
        if: steps.check-tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ needs.validate.outputs.version }}" \
            --title "Release ${{ needs.validate.outputs.version }}" \
            --generate-notes \
            --verify-tag

  tag:
    name: Tag Image for Test
    runs-on: ubuntu-latest
    needs: [validate, release]
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz"
          tar -xvzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          rm -f openshift-client-linux.tar.gz

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Tag Image
        run: |
          # Tag ci-latest as version
          oc tag ${{ env.IMAGE_NAME }}:ci-latest ${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version }} -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}
          
          # Tag version as test
          oc tag ${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version }} ${{ env.IMAGE_NAME }}:test -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

  deploy:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: [validate, tag]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        run: |
          curl -LO "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz"
          tar -xvzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          rm -f openshift-client-linux.tar.gz

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TEST }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.APP_NAME }} ./helm/${{ env.APP_NAME }} \
            --namespace ${{ env.OPENSHIFT_NAMESPACE_TEST }} \
            --values ./helm/${{ env.APP_NAME }}/values-test.yaml \
            --set image.tag=test \
            --set httpBasic.username=${{ secrets.RPROXY_USERNAME }} \
            --set httpBasic.password=${{ secrets.RPROXY_PASSWORD }} \
            --set httpBasic.public.username=${{ secrets.RPROXY_USERNAME }} \
            --set httpBasic.public.password=${{ secrets.RPROXY_PASSWORD }} \
            --wait \
            --timeout 5m

      - name: Verify Deployment
        run: |
          oc rollout status deployment/${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_TEST }} --timeout=5m
          oc get pods -l app.kubernetes.io/name=${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_TEST }}

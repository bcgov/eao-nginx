name: Deploy to Dev

on:
  push:
    branches:
      - master
    paths-ignore:
      - ".github/**"
      - "helm/rproxy/README.md"
      - "README.md"
  workflow_dispatch:

permissions: write-all

env:
  OPENSHIFT_NAMESPACE_TOOLS: 6cdc9e-tools
  OPENSHIFT_NAMESPACE_DEV: 6cdc9e-dev
  IMAGE_NAME: rproxy
  APP_NAME: rproxy

jobs:
  build:
    name: Build and Push  Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Build Image
        run: |
          oc start-build ${{ env.IMAGE_NAME }} \
            --from-dir=. \
            --follow \
            --wait \
            -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Get Image Digest
        id: get-digest
        run: |
          DIGEST=$(oc get istag ${{ env.IMAGE_NAME }}:latest -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }} -o jsonpath='{.image.metadata.name}')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Image digest: $DIGEST"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'image-registry.openshift-image-registry.svc:5000/${{ env.OPENSHIFT_NAMESPACE_TOOLS }}/${{ env.IMAGE_NAME }}@${{ steps.get-digest.outputs.digest }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  push:
    name: Tag Image for Dev
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Tag Image
        run: |
          # Tag as dev
          oc tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:dev -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}
          
          # Tag as CI latest
          oc tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:ci-latest -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}
          
          # Tag with commit SHA
          oc tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:${{ github.sha }} -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_DEV }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.APP_NAME }} ./helm/${{ env.APP_NAME }} \
            --namespace ${{ env.OPENSHIFT_NAMESPACE_DEV }} \
            --values ./helm/${{ env.APP_NAME }}/values-dev.yaml \
            --set image.tag=dev \
            --set httpBasic.username=${{ secrets.RPROXY_USERNAME }} \
            --set httpBasic.password=${{ secrets.RPROXY_PASSWORD }} \
            --set httpBasic.public.username=${{ secrets.RPROXY_USERNAME }} \
            --set httpBasic.public.password=${{ secrets.RPROXY_PASSWORD }} \
            --wait \
            --timeout 5m

      - name: Verify Deployment
        run: |
          oc rollout status deployment/${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_DEV }} --timeout=5m
          oc get pods -l app.kubernetes.io/name=${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_DEV }}

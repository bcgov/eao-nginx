name: Deploy to Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
        type: string

permissions: write-all

env:
  OPENSHIFT_NAMESPACE_TOOLS: 6cdc9e-tools
  OPENSHIFT_NAMESPACE_PROD: 6cdc9e-prod
  IMAGE_NAME: rproxy
  APP_NAME: rproxy

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format v1.2.3"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Git Tag Exists
        run: |
          if ! git rev-parse "${{ steps.validate.outputs.version }}" >/dev/null 2>&1; then
            echo "Error: Git tag ${{ steps.validate.outputs.version }} does not exist"
            echo "Please create a release in test environment first"
            exit 1
          fi
          echo "Git tag ${{ steps.validate.outputs.version }} verified"

  tag:
    name: Tag Image for Prod
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -LO "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz"
          tar -xvzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          rm -f openshift-client-linux.tar.gz

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Verify Image Tag Exists
        run: |
          if ! oc get istag ${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version }} -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }} &>/dev/null; then
            echo "Error: Image tag ${{ needs.validate.outputs.version }} does not exist"
            echo "Please deploy to test environment first"
            exit 1
          fi
          echo "Image tag ${{ needs.validate.outputs.version }} verified"

      - name: Tag Image for Prod
        run: |
          oc tag ${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version }} ${{ env.IMAGE_NAME }}:prod -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

  deploy:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    needs: [validate, tag]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        run: |
          curl -LO "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz"
          tar -xvzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          rm -f openshift-client-linux.tar.gz

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE_PROD }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.APP_NAME }} ./helm/${{ env.APP_NAME }} \
            --namespace ${{ env.OPENSHIFT_NAMESPACE_PROD }} \
            --values ./helm/${{ env.APP_NAME }}/values-prod.yaml \
            --set image.tag=prod \
            --set httpBasic.eguide.username=${{ secrets.RPROXY_EGUIDE_USERNAME }} \
            --set httpBasic.eguide.password=${{ secrets.RPROXY_EGUIDE_PASSWORD }} \
            --wait \
            --timeout 5m

      - name: Verify Deployment
        run: |
          oc rollout status deployment/${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_PROD }} --timeout=5m
          oc get pods -l app.kubernetes.io/name=${{ env.APP_NAME }} -n ${{ env.OPENSHIFT_NAMESPACE_PROD }}

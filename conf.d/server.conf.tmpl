# Ajax
server {
  listen       8080;
  server_name  ${NGINX__AJAX__SERVER_NAME};

  return 301 https://${NGINX__AJAX__REDIRECT};
}

#EPIC application server
server {
  listen       8080 default_server;
  server_name  ${NGINX__EPIC__SERVER_NAME};

  # Allows non-standard headers like SMGOV_USERGUID
  ignore_invalid_headers off;

  # 172.16.0.0/12 is the entire addressable space in the cluster
  #set_real_ip_from  172.51.0.0/22;
  #set_real_ip_from  172.51.4.0/22;
  #real_ip_header    X-Forwarded-For;

  location / {
    # proxy all traffic to this URL,
    # note the trailing slash strips out the /proxy path on
    # the request to the upstream server

    proxy_pass ${NGINX__EPIC__PROXY__ROOT};

    # Ensure HTTP get passed thru
    proxy_pass_request_headers on;

    # its helpful to cache these responses
    proxy_cache globalcache;

    # Deploy-time configurable
    ${HTTP_BASIC}
  }

  location /public {
    # proxy all traffic to this URL,
    # note the trailing slash strips out the /proxy path on
    # the request to the upstream server

    proxy_pass ${NGINX__EPIC__PROXY__PUBLIC};

    # Ensure HTTP get passed thru
    proxy_pass_request_headers on;

    # its helpful to cache these responses
    proxy_cache globalcache;

    # Deploy-time configurable
    ${HTTP_BASIC2}
  }

  # Redirect SSD fact sheet
  location = /api/public/document/673fa39fe2d737002260aaef/download/Fact_Sheet_PRGT_Substantial-Start-Determination.pdf {
    return 301 https://www2.gov.bc.ca/assets/download/F3F5FA681ADD4912B19A8DE62CBB451E;
  }

  # Analytics API - proxies to penguin-analytics service
  # Used by eagle-public and eagle-admin for anonymous usage tracking
  location /api/analytics/ {
    proxy_pass ${NGINX__EPIC__PROXY__ANALYTICS}/analytics;
    proxy_http_version 1.1;
    proxy_pass_request_headers on;
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  location /api {
    # proxy all traffic to this URL,
    # note the trailing slash strips out the /proxy path on
    # the request to the upstream server

    proxy_pass ${NGINX__EPIC__PROXY__API};

    # Ensure HTTP get passed thru
    proxy_pass_request_headers on;

    # its helpful to cache these responses
    proxy_cache globalcache;
  }

  location /admin/ {
    # proxy all traffic to this URL,
    # note the trailing slash strips out the /proxy path on
    # the request to the upstream server

    proxy_pass ${NGINX__EPIC__PROXY__ADMIN};

    # Ensure HTTP get passed thru
    proxy_pass_request_headers on;

    # its helpful to cache these responses
    proxy_cache globalcache;
  }

  # For e-guide service
  location /eguide {
    proxy_pass ${NGINX__EPIC__PROXY__EGUIDE};

    # Ensure HTTP get passed thru
    proxy_pass_request_headers on;

    # its helpful to cache these responses
    proxy_cache globalcache;

    ${HTTP_BASIC1}
  }

#  location /.well-known/acme-challenge {
#    proxy_pass ${NGINX__EPIC__PROXY__CERTBOT};
#
#    # Ensure HTTP get passed thru
#    proxy_pass_request_headers on;
#
#    # its helpful to cache these responses
#    proxy_cache globalcache;
#  }

  # Cache the lib directory
  location /lib {
    proxy_pass ${NGINX__EPIC__PROXY__ROOT};
    proxy_cache   globalcache;
  }

  # For status of ngnix service
  location /nginx_status {
    # Enable Nginx stats
    stub_status on;
    # Only allow access from localhost
    allow 127.0.0.1;
    # Other request should be denied
    deny all;
    # No need to log this request, its just noise
    access_log off;
  }
}
